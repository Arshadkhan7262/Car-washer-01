---
description: Debugging push notifications - backend sends but app doesn't receive
alwaysApply: false
globs: **/*notification*.dart,**/*notification*.js,**/*notification*.ts
---

# Push Notification Debugging Guide

## Backend Successfully Sends, But App Doesn't Receive

### âœ… Backend Logs Show Success

When backend successfully sends notification, you'll see:
```
âœ… [Notification] Successfully sent! Message ID: projects/upwork-task-8f47c/messages/0:...
ğŸ“± [Notification] Summary: Sent=1, Failed=0
âœ… Sent washer assigned notification to customer for booking CW-2026-XXXX
```

**This means**: Backend â†’ Firebase communication is working correctly.

### âŒ App Should Show These Logs (But Doesn't)

When app receives notification, you should see:

**Foreground (app is open):**
```
ğŸ“± [NotificationHandler] ==========================================
ğŸ“± [NotificationHandler] FOREGROUND NOTIFICATION RECEIVED
ğŸ“± [NotificationHandler] Message ID: [messageId]
ğŸ“± [NotificationHandler] Title: [title]
ğŸ“± [NotificationHandler] Body: [body]
ğŸ“± [NotificationHandler] Data: [data]
```

**Background (app minimized):**
```
ğŸ“± [Background] ==========================================
ğŸ“± [Background] BACKGROUND NOTIFICATION RECEIVED
ğŸ“± [Background] Title: [title]
ğŸ“± [Background] Body: [body]
```

### ğŸ” Root Cause Analysis

If backend shows `âœ… Successfully sent` but app shows NO notification logs:

#### Issue 1: FCM Token Mismatch (Most Common)
**Symptom**: Backend sends to token `dmMhcDBCSX26G_CqzLto22...` but app has different token
**Check**:
- Compare token in backend logs: `ğŸ“± [Notification] Token preview: dmMhcDBCSX26G_CqzLto22...`
- Compare with app logs: `ğŸ”‘ [FcmTokenController] FCM Token generated: ...`
- If different â†’ Token mismatch

**Fix**:
- App refreshes token on startup (in `InitialLoadingScreen`)
- Verify token saved to backend: `âœ… [FcmTokenService] FCM token saved successfully`
- Check database token matches app token

#### Issue 2: Notification Handler Not Initialized
**Symptom**: No `ğŸ“± [NotificationHandler]` logs at all
**Check**:
- App logs should show: `âœ… [NotificationHandler] Notification handlers initialized`
- If missing â†’ Handler not initialized

**Fix**:
- Ensure `NotificationHandlerService().initialize()` is called
- Check permission is granted: `ğŸ“± [NotificationHandler] Permission granted: authorized`
- Verify Firebase initialized: `âœ… Firebase initialized successfully`

#### Issue 3: Firebase Project Mismatch
**Symptom**: Backend sends successfully but Firebase doesn't deliver
**Check**:
- Backend project: `ğŸ“± [Firebase] Project ID: upwork-task-8f47c`
- App project: Check `firebase_options.dart` â†’ `projectId: 'upwork-task-8f47c'`
- Must match exactly

**Fix**:
- Verify both use same Firebase project
- Check `google-services.json` has correct project_id
- Ensure backend service account is for same project

### ğŸ“‹ Debugging Checklist

When notifications don't work:

1. **Check Backend Logs** (Terminal where backend runs):
   - âœ… `Successfully sent! Message ID: ...` = Backend working
   - âŒ `Failed to send` = Backend issue (check error code)

2. **Check App Logs** (Flutter console/logcat):
   - âœ… `FOREGROUND NOTIFICATION RECEIVED` = App receiving
   - âŒ No notification logs = App not receiving

3. **Compare FCM Tokens**:
   - Backend log: `Token preview: dmMhcDBCSX26G_CqzLto22...`
   - App log: `FCM Token generated: ...`
   - Database: Check user's `fcm_tokens` array
   - **Must all match!**

4. **Verify Handler Initialization**:
   - App should show: `âœ… [NotificationHandler] Notification handlers initialized`
   - Permission: `Permission granted: authorized`
   - Firebase: `âœ… Firebase initialized successfully`

### ğŸ¯ Quick Fixes

**If token mismatch:**
- Restart app (token refreshes on startup)
- Check `InitialLoadingScreen` refreshes token
- Verify token saved: `âœ… [FcmTokenService] FCM token saved successfully`

**If handler not initialized:**
- Check `main.dart` initializes notification handler
- Check `TrackOrderScreen` ensures handler initialized
- Verify permission granted

**If Firebase project mismatch:**
- Verify backend `.env` has correct `FIREBASE_PROJECT_ID`
- Check app `firebase_options.dart` matches
- Ensure `google-services.json` is correct

### ğŸ“Š Expected Flow

1. **Backend**: `âœ… Successfully sent! Message ID: ...`
2. **Firebase**: Delivers to device
3. **App**: `ğŸ“± FOREGROUND NOTIFICATION RECEIVED` (if app open)
4. **App**: Shows system notification
5. **App**: Triggers callback if registered

If step 1 works but step 3 doesn't â†’ Token mismatch or handler issue.
